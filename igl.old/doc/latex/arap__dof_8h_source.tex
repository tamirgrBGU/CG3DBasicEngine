\hypertarget{arap__dof_8h_source}{}\doxysection{arap\+\_\+dof.\+h}
\label{arap__dof_8h_source}\index{igl/arap\_dof.h@{igl/arap\_dof.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// This file is part of libigl, a simple c++ geometry processing library.}}
\DoxyCodeLine{2 \textcolor{comment}{// }}
\DoxyCodeLine{3 \textcolor{comment}{// Copyright (C) 2013 Alec Jacobson <alecjacobson@gmail.com>}}
\DoxyCodeLine{4 \textcolor{comment}{// }}
\DoxyCodeLine{5 \textcolor{comment}{// This Source Code Form is subject to the terms of the Mozilla Public License }}
\DoxyCodeLine{6 \textcolor{comment}{// v. 2.0. If a copy of the MPL was not distributed with this file, You can }}
\DoxyCodeLine{7 \textcolor{comment}{// obtain one at http://mozilla.org/MPL/2.0/.}}
\DoxyCodeLine{8 \textcolor{preprocessor}{\#ifndef IGL\_ARAP\_ENERGY\_TYPE\_DOF\_H}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#define IGL\_ARAP\_ENERGY\_TYPE\_DOF\_H}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include "{}igl\_inline.h"{}}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <Eigen/Dense>}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <Eigen/Sparse>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include "{}ARAPEnergyType.h"{}}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <vector>}}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 \textcolor{keyword}{namespace }igl}
\DoxyCodeLine{18 \{}
\DoxyCodeLine{19   \textcolor{comment}{// Caller example:}}
\DoxyCodeLine{20   \textcolor{comment}{//}}
\DoxyCodeLine{21   \textcolor{comment}{// Once:}}
\DoxyCodeLine{22   \textcolor{comment}{// arap\_dof\_precomputation(...)}}
\DoxyCodeLine{23   \textcolor{comment}{//}}
\DoxyCodeLine{24   \textcolor{comment}{// Each frame:}}
\DoxyCodeLine{25   \textcolor{comment}{// while(not satisfied)}}
\DoxyCodeLine{26   \textcolor{comment}{//   arap\_dof\_update(...)}}
\DoxyCodeLine{27   \textcolor{comment}{// end}}
\DoxyCodeLine{28   }
\DoxyCodeLine{29   \textcolor{keyword}{template} <\textcolor{keyword}{typename} LbsMatrixType, \textcolor{keyword}{typename} SSCALAR>}
\DoxyCodeLine{30   \textcolor{keyword}{struct }ArapDOFData;}
\DoxyCodeLine{31   }
\DoxyCodeLine{33   \textcolor{comment}{//}}
\DoxyCodeLine{34   \textcolor{comment}{// Arap DOF precomputation consists of two parts the computation. The first is}}
\DoxyCodeLine{35   \textcolor{comment}{// that which depends solely on the mesh (V,F), the linear blend skinning}}
\DoxyCodeLine{36   \textcolor{comment}{// weights (M) and the groups G. Then there's the part that depends on the}}
\DoxyCodeLine{37   \textcolor{comment}{// previous precomputation and the list of free and fixed vertices. }}
\DoxyCodeLine{38   \textcolor{comment}{//}}
\DoxyCodeLine{40 \textcolor{comment}{}  }
\DoxyCodeLine{41   }
\DoxyCodeLine{42   \textcolor{comment}{// The code and variables differ from the description in Section 3 of "{}Fast}}
\DoxyCodeLine{43   \textcolor{comment}{// Automatic Skinning Transformations"{} by [Jacobson et al. 2012]}}
\DoxyCodeLine{44   \textcolor{comment}{// }}
\DoxyCodeLine{45   \textcolor{comment}{// Here is a useful conversion table:}}
\DoxyCodeLine{46   \textcolor{comment}{//}}
\DoxyCodeLine{47   \textcolor{comment}{// [article]                             [code]}}
\DoxyCodeLine{48   \textcolor{comment}{// S = \(\backslash\)tilde\{K\} T                       S = CSM * Lsep}}
\DoxyCodeLine{49   \textcolor{comment}{// S -\/-\/> R                               S -\/-\/> R -\/-\/shuffled-\/-\/> Rxyz}}
\DoxyCodeLine{50   \textcolor{comment}{// Gamma\_solve RT = Pi\_1 \(\backslash\)tilde\{K\} RT    L\_part1xyz = CSolveBlock1 * Rxyz }}
\DoxyCodeLine{51   \textcolor{comment}{// Pi\_1 \(\backslash\)tilde\{K\}                        CSolveBlock1}}
\DoxyCodeLine{52   \textcolor{comment}{// Peq = [T\_full; P\_pos]                 }}
\DoxyCodeLine{53   \textcolor{comment}{// T\_full                                B\_eq\_fix <-\/-\/-\/ L0}}
\DoxyCodeLine{54   \textcolor{comment}{// P\_pos                                 B\_eq}}
\DoxyCodeLine{55   \textcolor{comment}{// Pi\_2 * P\_eq =                         Lpart2and3 = Lpart2 + Lpart3}}
\DoxyCodeLine{56   \textcolor{comment}{//   Pi\_2\_left T\_full +                  Lpart3 = M\_fullsolve(right) * B\_eq\_fix}}
\DoxyCodeLine{57   \textcolor{comment}{//   Pi\_2\_right P\_pos                    Lpart2 = M\_fullsolve(left) * B\_eq}}
\DoxyCodeLine{58   \textcolor{comment}{// T = [Pi\_1 Pi\_2] [\(\backslash\)tilde\{K\}TRT P\_eq]   L = Lpart1 + Lpart2and3}}
\DoxyCodeLine{59   \textcolor{comment}{//}}
\DoxyCodeLine{60   }
\DoxyCodeLine{61   \textcolor{comment}{// Precomputes the system we are going to optimize. This consists of building}}
\DoxyCodeLine{62   \textcolor{comment}{// constructor matrices (to compute covariance matrices from transformations}}
\DoxyCodeLine{63   \textcolor{comment}{// and to build the poisson solve right hand side from rotation matrix entries)}}
\DoxyCodeLine{64   \textcolor{comment}{// and also prefactoring the poisson system.}}
\DoxyCodeLine{65   \textcolor{comment}{//}}
\DoxyCodeLine{66   \textcolor{comment}{// Inputs:}}
\DoxyCodeLine{67   \textcolor{comment}{//   V  \#V by dim list of vertex positions}}
\DoxyCodeLine{68   \textcolor{comment}{//   F  \#F by \{3|4\} list of face indices}}
\DoxyCodeLine{69   \textcolor{comment}{//   M  \#V * dim by \#handles * dim * (dim+1) matrix such that}}
\DoxyCodeLine{70   \textcolor{comment}{//     new\_V(:) = LBS(V,W,A) = reshape(M * A,size(V)), where A is a column}}
\DoxyCodeLine{71   \textcolor{comment}{//     vectors formed by the entries in each handle's dim by dim+1 }}
\DoxyCodeLine{72   \textcolor{comment}{//     transformation matrix. Specifcally, A =}}
\DoxyCodeLine{73   \textcolor{comment}{//       reshape(permute(Astack,[3 1 2]),n*dim*(dim+1),1)}}
\DoxyCodeLine{74   \textcolor{comment}{//     or A = [Lxx;Lyx;Lxy;Lyy;tx;ty], and likewise for other dim}}
\DoxyCodeLine{75   \textcolor{comment}{//     if Astack(:,:,i) is the dim by (dim+1) transformation at handle i}}
\DoxyCodeLine{76   \textcolor{comment}{//     handles are ordered according to P then BE (point handles before bone}}
\DoxyCodeLine{77   \textcolor{comment}{//     handles)}}
\DoxyCodeLine{78   \textcolor{comment}{//   G  \#V list of group indices (1 to k) for each vertex, such that vertex i }}
\DoxyCodeLine{79   \textcolor{comment}{//     is assigned to group G(i)}}
\DoxyCodeLine{80   \textcolor{comment}{// Outputs:}}
\DoxyCodeLine{81   \textcolor{comment}{//   data  structure containing all necessary precomputation for calling}}
\DoxyCodeLine{82   \textcolor{comment}{//     arap\_dof\_update}}
\DoxyCodeLine{83   \textcolor{comment}{// Returns true on success, false on error}}
\DoxyCodeLine{84   \textcolor{comment}{//}}
\DoxyCodeLine{85   \textcolor{comment}{// See also: lbs\_matrix\_column}}
\DoxyCodeLine{86   \textcolor{keyword}{template} <\textcolor{keyword}{typename} LbsMatrixType, \textcolor{keyword}{typename} SSCALAR>}
\DoxyCodeLine{87   IGL\_INLINE \textcolor{keywordtype}{bool} arap\_dof\_precomputation(}
\DoxyCodeLine{88     \textcolor{keyword}{const} Eigen::MatrixXd \& V, }
\DoxyCodeLine{89     \textcolor{keyword}{const} Eigen::MatrixXi \& F,}
\DoxyCodeLine{90     \textcolor{keyword}{const} LbsMatrixType \& M,}
\DoxyCodeLine{91     \textcolor{keyword}{const} Eigen::Matrix<int,Eigen::Dynamic,1> \& G,}
\DoxyCodeLine{92     ArapDOFData<LbsMatrixType, SSCALAR> \& data);}
\DoxyCodeLine{93   }
\DoxyCodeLine{94   \textcolor{comment}{// Should always be called after arap\_dof\_precomputation, but may be called in}}
\DoxyCodeLine{95   \textcolor{comment}{// between successive calls to arap\_dof\_update, recomputes precomputation}}
\DoxyCodeLine{96   \textcolor{comment}{// given that there are only changes in free and fixed}}
\DoxyCodeLine{97   \textcolor{comment}{//}}
\DoxyCodeLine{98   \textcolor{comment}{// Inputs:}}
\DoxyCodeLine{99   \textcolor{comment}{//   fixed\_dim  list of transformation element indices for fixed (or partailly}}
\DoxyCodeLine{100   \textcolor{comment}{//   fixed) handles: not necessarily the complement of 'free'}}
\DoxyCodeLine{101   \textcolor{comment}{//    NOTE: the constraints for fixed transformations still need to be}}
\DoxyCodeLine{102   \textcolor{comment}{//    present in A\_eq}}
\DoxyCodeLine{103   \textcolor{comment}{//   A\_eq  dim*\#constraint\_points by m*dim*(dim+1)  matrix of linear equality}}
\DoxyCodeLine{104   \textcolor{comment}{//     constraint coefficients. Each row corresponds to a linear constraint,}}
\DoxyCodeLine{105   \textcolor{comment}{//     so that A\_eq * L = Beq says that the linear transformation entries in}}
\DoxyCodeLine{106   \textcolor{comment}{//     the column L should produce the user supplied positional constraints}}
\DoxyCodeLine{107   \textcolor{comment}{//     for each handle in Beq. The row A\_eq(i*dim+d) corresponds to the}}
\DoxyCodeLine{108   \textcolor{comment}{//     constrain on coordinate d of position i}}
\DoxyCodeLine{109   \textcolor{comment}{// Outputs:}}
\DoxyCodeLine{110   \textcolor{comment}{//   data  structure containing all necessary precomputation for calling}}
\DoxyCodeLine{111   \textcolor{comment}{//     arap\_dof\_update}}
\DoxyCodeLine{112   \textcolor{comment}{// Returns true on success, false on error}}
\DoxyCodeLine{113   \textcolor{comment}{//}}
\DoxyCodeLine{114   \textcolor{comment}{// See also: lbs\_matrix\_column}}
\DoxyCodeLine{115   \textcolor{keyword}{template} <\textcolor{keyword}{typename} LbsMatrixType, \textcolor{keyword}{typename} SSCALAR>}
\DoxyCodeLine{116   IGL\_INLINE \textcolor{keywordtype}{bool} arap\_dof\_recomputation(}
\DoxyCodeLine{117     \textcolor{keyword}{const} Eigen::Matrix<int,Eigen::Dynamic,1> \& fixed\_dim,}
\DoxyCodeLine{118     \textcolor{keyword}{const} Eigen::SparseMatrix<double> \& A\_eq,}
\DoxyCodeLine{119     ArapDOFData<LbsMatrixType, SSCALAR> \& data);}
\DoxyCodeLine{120   }
\DoxyCodeLine{121   \textcolor{comment}{// Optimizes the transformations attached to each weight function based on}}
\DoxyCodeLine{122   \textcolor{comment}{// precomputed system.}}
\DoxyCodeLine{123   \textcolor{comment}{//}}
\DoxyCodeLine{124   \textcolor{comment}{// Inputs:}}
\DoxyCodeLine{125   \textcolor{comment}{//   data  precomputation data struct output from arap\_dof\_precomputation}}
\DoxyCodeLine{126   \textcolor{comment}{//   Beq  dim*\#constraint\_points constraint values.}}
\DoxyCodeLine{127   \textcolor{comment}{//   L0  \#handles * dim * dim+1 list of initial guess transformation entries,}}
\DoxyCodeLine{128   \textcolor{comment}{//     also holds fixed transformation entries for fixed handles}}
\DoxyCodeLine{129   \textcolor{comment}{//   max\_iters  maximum number of iterations}}
\DoxyCodeLine{130   \textcolor{comment}{//   tol  stopping criteria parameter. If variables (linear transformation}}
\DoxyCodeLine{131   \textcolor{comment}{//     matrix entries) change by less than 'tol' the optimization terminates,}}
\DoxyCodeLine{132   \textcolor{comment}{//       0.75 (weak tolerance)}}
\DoxyCodeLine{133   \textcolor{comment}{//       0.0 (extreme tolerance)}}
\DoxyCodeLine{134   \textcolor{comment}{// Outputs:}}
\DoxyCodeLine{135   \textcolor{comment}{//   L  \#handles * dim * dim+1 list of final optimized transformation entries,}}
\DoxyCodeLine{136   \textcolor{comment}{//     allowed to be the same as L}}
\DoxyCodeLine{137   \textcolor{keyword}{template} <\textcolor{keyword}{typename} LbsMatrixType, \textcolor{keyword}{typename} SSCALAR>}
\DoxyCodeLine{138   IGL\_INLINE \textcolor{keywordtype}{bool} arap\_dof\_update(}
\DoxyCodeLine{139     \textcolor{keyword}{const} ArapDOFData<LbsMatrixType,SSCALAR> \& data,}
\DoxyCodeLine{140     \textcolor{keyword}{const} Eigen::Matrix<double,Eigen::Dynamic,1> \& B\_eq,}
\DoxyCodeLine{141     \textcolor{keyword}{const} Eigen::MatrixXd \& L0,}
\DoxyCodeLine{142     \textcolor{keyword}{const} \textcolor{keywordtype}{int} max\_iters,}
\DoxyCodeLine{143     \textcolor{keyword}{const} \textcolor{keywordtype}{double} tol,}
\DoxyCodeLine{144     Eigen::MatrixXd \& L}
\DoxyCodeLine{145     );}
\DoxyCodeLine{146   }
\DoxyCodeLine{147   \textcolor{comment}{// Structure that contains fields for all precomputed data or data that needs}}
\DoxyCodeLine{148   \textcolor{comment}{// to be remembered at update}}
\DoxyCodeLine{149   \textcolor{keyword}{template} <\textcolor{keyword}{typename} LbsMatrixType, \textcolor{keyword}{typename} SSCALAR>}
\DoxyCodeLine{150   \textcolor{keyword}{struct }\mbox{\hyperlink{structigl_1_1_arap_d_o_f_data}{ArapDOFData}}}
\DoxyCodeLine{151   \{}
\DoxyCodeLine{152     \textcolor{keyword}{typedef} Eigen::Matrix<SSCALAR, Eigen::Dynamic, Eigen::Dynamic> MatrixXS;}
\DoxyCodeLine{153     \textcolor{comment}{// Type of arap energy we're solving}}
\DoxyCodeLine{154     igl::ARAPEnergyType energy;}
\DoxyCodeLine{157     \textcolor{comment}{//igl::min\_quad\_with\_fixed\_data<double> lu\_data;}}
\DoxyCodeLine{158     \textcolor{comment}{// List of indices of fixed transformation entries}}
\DoxyCodeLine{159     Eigen::Matrix<int,Eigen::Dynamic,1> fixed\_dim;}
\DoxyCodeLine{160     \textcolor{comment}{// List of precomputed covariance scatter matrices multiplied by lbs}}
\DoxyCodeLine{161     \textcolor{comment}{// matrices}}
\DoxyCodeLine{162     \textcolor{comment}{//std::vector<Eigen::SparseMatrix<double> > CSM\_M;}}
\DoxyCodeLine{163     std::vector<Eigen::MatrixXd> CSM\_M;}
\DoxyCodeLine{164     LbsMatrixType M\_KG;}
\DoxyCodeLine{165     \textcolor{comment}{// Number of mesh vertices}}
\DoxyCodeLine{166     \textcolor{keywordtype}{int} n;}
\DoxyCodeLine{167     \textcolor{comment}{// Number of weight functions}}
\DoxyCodeLine{168     \textcolor{keywordtype}{int} m;}
\DoxyCodeLine{169     \textcolor{comment}{// Number of dimensions}}
\DoxyCodeLine{170     \textcolor{keywordtype}{int} dim;}
\DoxyCodeLine{171     \textcolor{comment}{// Effective dimensions}}
\DoxyCodeLine{172     \textcolor{keywordtype}{int} effective\_dim;}
\DoxyCodeLine{173     \textcolor{comment}{// List of indices into C of positional constraints}}
\DoxyCodeLine{174     Eigen::Matrix<int,Eigen::Dynamic,1> interpolated;}
\DoxyCodeLine{175     std::vector<bool> free\_mask;}
\DoxyCodeLine{176     \textcolor{comment}{// Full quadratic coefficients matrix before lagrangian (should be dense)}}
\DoxyCodeLine{177     LbsMatrixType Q;}
\DoxyCodeLine{178   }
\DoxyCodeLine{179   }
\DoxyCodeLine{181     \textcolor{comment}{//Eigen::MatrixXd M\_Solve; // TODO: remove from here}}
\DoxyCodeLine{182   }
\DoxyCodeLine{183     \textcolor{comment}{// Full solve matrix that contains also conversion from rotations to the right hand side, }}
\DoxyCodeLine{184     \textcolor{comment}{// i.e., solves Poisson transformations just from rotations and positional constraints}}
\DoxyCodeLine{185     MatrixXS M\_FullSolve;}
\DoxyCodeLine{186   }
\DoxyCodeLine{187     \textcolor{comment}{// Precomputed condensed matrices (3x3 commutators folded to 1x1):}}
\DoxyCodeLine{188     MatrixXS CSM;}
\DoxyCodeLine{189     MatrixXS CSolveBlock1;}
\DoxyCodeLine{190   }
\DoxyCodeLine{191     \textcolor{comment}{// Print timings at each update}}
\DoxyCodeLine{192     \textcolor{keywordtype}{bool} print\_timings;}
\DoxyCodeLine{193   }
\DoxyCodeLine{194     \textcolor{comment}{// Dynamics}}
\DoxyCodeLine{195     \textcolor{keywordtype}{bool} with\_dynamics;}
\DoxyCodeLine{196     \textcolor{comment}{// I'm hiding the extra dynamics stuff in this struct, which sort of defeats}}
\DoxyCodeLine{197     \textcolor{comment}{// the purpose of this function-\/based coding style...}}
\DoxyCodeLine{198   }
\DoxyCodeLine{199     \textcolor{comment}{// Time step}}
\DoxyCodeLine{200     \textcolor{keywordtype}{double} h;}
\DoxyCodeLine{201   }
\DoxyCodeLine{202     \textcolor{comment}{// L0  \#handles * dim * dim+1 list of transformation entries from}}
\DoxyCodeLine{203     \textcolor{comment}{// previous solve}}
\DoxyCodeLine{204     MatrixXS L0;}
\DoxyCodeLine{207     \textcolor{comment}{//MatrixXS Lm1;}}
\DoxyCodeLine{208     \textcolor{comment}{// "{}Velocity"{}}}
\DoxyCodeLine{209     MatrixXS Lvel0;}
\DoxyCodeLine{210   }
\DoxyCodeLine{211     \textcolor{comment}{// \#V by dim matrix of external forces}}
\DoxyCodeLine{212     \textcolor{comment}{// fext}}
\DoxyCodeLine{213     MatrixXS fext;}
\DoxyCodeLine{214   }
\DoxyCodeLine{215     \textcolor{comment}{// Mass\_tilde: MT * Mass * M}}
\DoxyCodeLine{216     LbsMatrixType Mass\_tilde;}
\DoxyCodeLine{217   }
\DoxyCodeLine{218     \textcolor{comment}{// Force due to gravity (premultiplier)}}
\DoxyCodeLine{219     Eigen::MatrixXd fgrav;}
\DoxyCodeLine{220     \textcolor{comment}{// Direction of gravity}}
\DoxyCodeLine{221     Eigen::Vector3d grav\_dir;}
\DoxyCodeLine{222     \textcolor{comment}{// Magnitude of gravity}}
\DoxyCodeLine{223     \textcolor{keywordtype}{double} grav\_mag;}
\DoxyCodeLine{224     }
\DoxyCodeLine{225     \textcolor{comment}{// Π1 from the paper}}
\DoxyCodeLine{226     MatrixXS Pi\_1;}
\DoxyCodeLine{227   }
\DoxyCodeLine{228     \textcolor{comment}{// Default values}}
\DoxyCodeLine{229     \mbox{\hyperlink{structigl_1_1_arap_d_o_f_data}{ArapDOFData}}(): }
\DoxyCodeLine{230       energy(igl::ARAP\_ENERGY\_TYPE\_SPOKES), }
\DoxyCodeLine{231       with\_dynamics(\textcolor{keyword}{false}),}
\DoxyCodeLine{232       h(1),}
\DoxyCodeLine{233       grav\_dir(0,-\/1,0),}
\DoxyCodeLine{234       grav\_mag(0)}
\DoxyCodeLine{235     \{}
\DoxyCodeLine{236     \}}
\DoxyCodeLine{237   \};}
\DoxyCodeLine{238 \}}
\DoxyCodeLine{239 }
\DoxyCodeLine{240 \textcolor{preprocessor}{\#ifndef IGL\_STATIC\_LIBRARY}}
\DoxyCodeLine{241 \textcolor{preprocessor}{\#  include "{}arap\_dof.cpp"{}}}
\DoxyCodeLine{242 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{243 }
\DoxyCodeLine{244 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
